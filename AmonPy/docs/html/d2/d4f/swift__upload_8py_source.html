<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>AmonPy: amonpy/dbase/detector_specific/swift_upload.py Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../amon_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">AmonPy
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Packages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_f1e1ec71509ab44bf4056656a40d78fd.html">amonpy</a></li><li class="navelem"><a class="el" href="../../dir_390d3981b81a8b72ee90a1ee98c48bbc.html">dbase</a></li><li class="navelem"><a class="el" href="../../dir_e3da1d4e4547eb0ec9d998893577bed3.html">detector_specific</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">swift_upload.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d4f/swift__upload_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html">    1</a></span>&#160;<span class="comment">#</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"># Before running, make sure to add a row in eventStreamConfig table in the database that has a stream number assigned to the triggering observatory (for example number 4 for swift). That can be done by running only the testWriteConfigArchive(self) function in /amonpy/dbase/test/test_db_write.py.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">import</span> pyfits</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> MySQLdb <span class="keyword">as</span> mdb</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> getpass</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> swift_functions <span class="keyword">as</span> swift</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">import</span> math</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">import</span> glob</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">from</span> scipy.interpolate <span class="keyword">import</span> interp1d</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">import</span> itertools</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> sys</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#afb3aeedcd6324609616af510e7d5ab77">   15</a></span>&#160;<span class="keyword">def </span><a class="code" href="../../d2/df9/namespaceswift__upload.html#afb3aeedcd6324609616af510e7d5ab77">parse_command_line</a>():</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    parser = ArgumentParser()</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;--attitude-files&quot;</span>, default=<span class="stringliteral">&#39;/usr/local/amon/data_storage/Swift_Sub_Sub/attitude_files/monthly_files&#39;</span>, help=<span class="stringliteral">&quot;Path to attitude files directory [default: /usr/local/amon/data_storage/Swift_Sub_Sub/attitude_files/monthly_files]&quot;</span>)</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;--fits-files&quot;</span>, default=<span class="stringliteral">&#39;/usr/local/amon/data_storage/Swift_Sub_Sub/monthly_data&#39;</span>, help=<span class="stringliteral">&quot;Path to fits files directory [default: /usr/local/amon/data_storage/Swift_Sub_Sub/monthly_data]&quot;</span>)</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;--pvalue-file&quot;</span>, default=<span class="stringliteral">&#39;pvalue_table.txt&#39;</span>, help=<span class="stringliteral">&quot;Path to SNR to P-Value table [default: pvalue_table.txt]&quot;</span>)</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;--scramble-timestamps&quot;</span>, action=<span class="stringliteral">&quot;store_true&quot;</span>, help=<span class="stringliteral">&quot;Use scrambled time stamps [default: False]&quot;</span>)</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-H&quot;</span>, <span class="stringliteral">&quot;--host&quot;</span>, metavar=<span class="stringliteral">&quot;address&quot;</span>, default=<span class="stringliteral">&#39;db.hpc.rcc.psu.edu&#39;</span>, </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;            help=<span class="stringliteral">&quot;Database host address [default: db.hpc.rcc.psu.edu]&quot;</span>)</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="comment"># TODO Add feature to pull username from login information so that the</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="comment"># username option is optional, similar to how MySQL is used from the command</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="comment"># line</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-u&quot;</span>, <span class="stringliteral">&quot;--username&quot;</span>, metavar=<span class="stringliteral">&quot;username&quot;</span>, help=<span class="stringliteral">&quot;Database username&quot;</span>)</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-d&quot;</span>, <span class="stringliteral">&quot;--database&quot;</span>, metavar=<span class="stringliteral">&quot;name&quot;</span>, help=<span class="stringliteral">&quot;Name of database&quot;</span>)</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keywordflow">return</span> parser.parse_args()</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">##</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">#  Class to interpolate latitude, longitude, and elevation values from data taken from Swift attitude files The relevant data from the attitude files are currently grouped in txt files with four columns, in this order: time, latitude, longitude, elevation</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">#   </span></div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html">   34</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html" title="Class to interpolate latitude, longitude, and elevation values from data taken from Swift attitude fi...">attitude</a>:</div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac99f688772e96b5303f40adefa07e646">   35</a></span>&#160;    <span class="keyword">def </span><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac99f688772e96b5303f40adefa07e646">__init__</a>(self,pos_files):</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        <span class="comment"># Store the list of files, as well as start counting which</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="comment"># element in the list is currently being used. </span></div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7eb9757c91199dd9a44246678daa1049">   38</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7eb9757c91199dd9a44246678daa1049">file_locs</a> = pos_files </div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a5a86e47a33e8621d28b5eb4fd600ff6f">   39</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a5a86e47a33e8621d28b5eb4fd600ff6f">file_num</a> = 0</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a393d23e7314de06fd487536ae42adf8c">compute_interpolate_position</a>()</div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac941b470c877ac9b1e9d6e5130fdd82e">   41</a></span>&#160;                self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac941b470c877ac9b1e9d6e5130fdd82e">files_exhausted</a> = <span class="keyword">False</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a393d23e7314de06fd487536ae42adf8c">   43</a></span>&#160;    <span class="keyword">def </span><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a393d23e7314de06fd487536ae42adf8c">compute_interpolate_position</a>(self):</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        <span class="comment"># Opens the files, stores the information in lists, then</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="comment"># creates interpolated class objects for latitude, longitude,</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        <span class="comment"># and elevation</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;Opening monthly attitude file %s&#39;</span> % self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7eb9757c91199dd9a44246678daa1049">file_locs</a>[self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a5a86e47a33e8621d28b5eb4fd600ff6f">file_num</a>]</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        monthly_data = open(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7eb9757c91199dd9a44246678daa1049">file_locs</a>[self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a5a86e47a33e8621d28b5eb4fd600ff6f">file_num</a>],<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="stringliteral">        position_data = []</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="stringliteral">        </span><span class="keywordflow">for</span> row <span class="keywordflow">in</span> monthly_data.readlines():</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;            position_data.append([float(value) <span class="keywordflow">for</span> value <span class="keywordflow">in</span> row.split(<span class="stringliteral">&#39; &#39;</span>)])</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        position_data_izip = itertools.izip(*position_data)</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">   53</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a> = position_data_izip.next()</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        latitude = position_data_izip.next()</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        longitude = position_data_izip.next()</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        elevation = position_data_izip.next()</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a6d512f1ccc9aef20f398c074c4fee60f">   57</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a6d512f1ccc9aef20f398c074c4fee60f">interp_latitude</a> = interp1d(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>,latitude)</div>
<div class="line"><a name="l00058"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#acc0cf2dc8573ea6cebf0e3fd83df6dd7">   58</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#acc0cf2dc8573ea6cebf0e3fd83df6dd7">interp_longitude</a> = interp1d(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>,longitude)</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7604e09edcd1b292c656a937fb33d462">   59</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7604e09edcd1b292c656a937fb33d462">interp_elevation</a> = interp1d(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>,elevation)</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="comment"># A check to ensure validity of interpolation.  Values</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="comment"># interpolated in gaps greater than 600 seconds (invalid_gaps)</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="comment"># should not be trusted, values interpolated in gaps between</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="comment"># 100 and 600 seconds (warning_gaps) can be trusted, but the</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <span class="comment"># user should be made aware that the values will be less</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="comment"># accurate </span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        attitude_time_check = [time2 - time1 <span class="keywordflow">for</span> time1, time2 <span class="keywordflow">in</span> zip(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>[:-1], self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>[1:])]</div>
<div class="line"><a name="l00068"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a8644c4ef3043a6ed4173a22a158855c5">   68</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a8644c4ef3043a6ed4173a22a158855c5">warning_gaps</a> = [arg_gap <span class="keywordflow">for</span> arg_gap, gap <span class="keywordflow">in</span> enumerate(attitude_time_check) <span class="keywordflow">if</span> gap &gt;= 100]</div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7e94e961a197f72b4ce146a86101e25b">   69</a></span>&#160;        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7e94e961a197f72b4ce146a86101e25b">invalid_gaps</a> = [arg_gap <span class="keywordflow">for</span> arg_gap <span class="keywordflow">in</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a8644c4ef3043a6ed4173a22a158855c5">warning_gaps</a> <span class="keywordflow">if</span> attitude_time_check[arg_gap] &gt;= 600]</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#abd05d9be607987027b4e5670f53c5b17">   71</a></span>&#160;    <span class="keyword">def </span><a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#abd05d9be607987027b4e5670f53c5b17">interpolate_position</a>(self,event):</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="comment"># Attempt to interpolate the values of lat, long, and elev with</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="comment"># observation time.  If observation time is before the attitude</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="comment"># time window starts, set the values to None.  If it&#39;s after</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="comment"># the attitude time window, go to the next attitude file</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac941b470c877ac9b1e9d6e5130fdd82e">files_exhausted</a>:</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                                latitude = (float(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a6d512f1ccc9aef20f398c074c4fee60f">interp_latitude</a>(event.observation_time)),)*event.num_detection</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                                longitude = (float(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#acc0cf2dc8573ea6cebf0e3fd83df6dd7">interp_longitude</a>(event.observation_time)),)*event.num_detection</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                elevation = (float(self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7604e09edcd1b292c656a937fb33d462">interp_elevation</a>(event.observation_time)),)*event.num_detection</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                                <span class="comment"># Make sure time of observed event takes places in a</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                                <span class="comment"># complete section of the attitude files.  If not, the</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                                <span class="comment"># interpolated value can be less accurate or even</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                                <span class="comment"># wrong.  </span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                <span class="keywordflow">for</span> warning_arg <span class="keywordflow">in</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a8644c4ef3043a6ed4173a22a158855c5">warning_gaps</a>:</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                                        <span class="keywordflow">if</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>[warning_arg] &lt; event.observation_time &lt; self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a31fae6bcf3664084a8ff477d6b780e9e">attitude_time</a>[warning_arg+1]:</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                                                event.set_position_flag()</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                                                <span class="keywordflow">if</span> warning_arg <span class="keywordflow">in</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a7e94e961a197f72b4ce146a86101e25b">invalid_gaps</a>:</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                                                        latitude = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                                                        longitude = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                                                        elevation = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                                event.set_position_flag()</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                                latitude = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                                longitude = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                                elevation = (<span class="keywordtype">None</span>,)*event.num_detection</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            <span class="keywordflow">return</span> latitude, longitude, elevation</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">except</span> ValueError:</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                        self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a5a86e47a33e8621d28b5eb4fd600ff6f">file_num</a> += 1</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                                self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#a393d23e7314de06fd487536ae42adf8c">compute_interpolate_position</a>()</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                        <span class="keywordflow">except</span> IndexError:</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                                self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#ac941b470c877ac9b1e9d6e5130fdd82e">files_exhausted</a> = <span class="keyword">True</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                        <span class="keywordflow">return</span> self.<a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html#abd05d9be607987027b4e5670f53c5b17">interpolate_position</a>(event)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">##</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"># </span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">#   Class to store all of the information needed by the MySQL database for a set of observations at a given time.</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">#   Information will be stored in tuples, and each observation in a given detection will have its own tuple element</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">#   i.e. if there are two observations at the same time, the time tuple will be a 2 element tuple of identical times</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">#   </span></div>
<div class="line"><a name="l00113"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html">  113</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html" title="Class to store all of the information needed by the MySQL database for a set of observations at a giv...">observation</a>:</div>
<div class="line"><a name="l00114"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#adc476d37d9350c9a8026212b18ca064a">  114</a></span>&#160;    <span class="keyword">def </span><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#adc476d37d9350c9a8026212b18ca064a">__init__</a>(self, row, data_list_arg, pvalue_interp_class, positions):</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment"># First check with observations have valid SNR values, those</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="comment"># are the only events we care about.  The fits file may have</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="comment"># observations without SNR values, which are useless to us.  In</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="comment"># addition, the file is set up to have up to 20 observations at</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="comment"># a time, which is rarely the case.  Many columns in the file</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment"># have arrays of 20 elements, and any that aren&#39;t being used</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment"># have Nan elements.  e.g. if there&#39;s only 2 events, an array</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment"># may look like [value1, value2, NaN, NaN,...,NaN]</span></div>
<div class="line"><a name="l00123"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#af99687a759f84b56ed61f2c1b3688dd8">  123</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#af99687a759f84b56ed61f2c1b3688dd8">snr</a> = tuple(snr <span class="keywordflow">for</span> snr <span class="keywordflow">in</span> row[data_list_arg[<span class="stringliteral">&#39;SNR&#39;</span>]] <span class="keywordflow">if</span> <span class="keywordflow">not</span> math.isnan(snr))</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="comment"># Check how many detections were made at the time of this</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="comment"># observation</span></div>
<div class="line"><a name="l00127"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">  127</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a> = len(self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#af99687a759f84b56ed61f2c1b3688dd8">snr</a>)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="comment"># Set Swift stream number as 1, and use hardcoded revision</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="comment"># number and stream revision number of 0</span></div>
<div class="line"><a name="l00131"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a9596485585ce74140b825512aee37c79">  131</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a9596485585ce74140b825512aee37c79">stream_config</a> = (4,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00132"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a99450dace25eab8b2c7a3c75262cc524">  132</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a99450dace25eab8b2c7a3c75262cc524">rev</a> = (0,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00133"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a13b133ec0b17e5a5698be9fc66c012a7">  133</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a13b133ec0b17e5a5698be9fc66c012a7">stream_rev</a> = (0,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="comment"># Get the observation time, which is in seconds since the</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="comment"># launch of the Swift satellite.  Use met2day function in</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="comment"># swift_custom_module to split into time stamp and msec</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment"># components Currently set to use random time stamps</span></div>
<div class="line"><a name="l00139"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4dbc6c0a4f95d314d24df1dfa6a2fc75">  139</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4dbc6c0a4f95d314d24df1dfa6a2fc75">observation_time</a> = row[data_list_arg[<span class="stringliteral">&#39;TIME&#39;</span>]]</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                <span class="comment"># TODO Add command line option to decide if using random time</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                <span class="comment"># stamps or real ones</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                <span class="keywordflow">if</span> options.scramble_timestamps:</div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a162639895089c8cbac963b1413ae8d6d">  143</a></span>&#160;                    self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a162639895089c8cbac963b1413ae8d6d">time</a> = swift.random_time_stamp(self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a>)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                    self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a162639895089c8cbac963b1413ae8d6d">time</a> = (swift.met2day(self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4dbc6c0a4f95d314d24df1dfa6a2fc75">observation_time</a>)[0],) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a486373332832fa180cbcc1548b6365a6">  146</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a486373332832fa180cbcc1548b6365a6">time_msec</a> = (swift.met2day(self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4dbc6c0a4f95d314d24df1dfa6a2fc75">observation_time</a>)[1],) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment"># Get the ra and dec of the source</span></div>
<div class="line"><a name="l00149"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ac212201c826046a1d357ebed26ee9b46">  149</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ac212201c826046a1d357ebed26ee9b46">ra_obj</a> = tuple(ra <span class="keywordflow">for</span> ra <span class="keywordflow">in</span> row[data_list_arg[<span class="stringliteral">&#39;RA_OBJ&#39;</span>]][:self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a>])</div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a2ca67fdaf250b67b7ee097b51a271d76">  150</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a2ca67fdaf250b67b7ee097b51a271d76">dec_obj</a> = tuple(dec <span class="keywordflow">for</span> dec <span class="keywordflow">in</span> row[data_list_arg[<span class="stringliteral">&#39;DEC_OBJ&#39;</span>]][:self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a>])</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="comment"># Get the ra and dec of the center of the decector</span></div>
<div class="line"><a name="l00153"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a79c65fb1e89fc6bcf25f4984dce737ed">  153</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a79c65fb1e89fc6bcf25f4984dce737ed">ra_cent</a> = (row[data_list_arg[<span class="stringliteral">&#39;RA_CENT&#39;</span>]],) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a46af6a7fc09df9b0b4224affe3c1431d">  154</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a46af6a7fc09df9b0b4224affe3c1431d">dec_cent</a> = (row[data_list_arg[<span class="stringliteral">&#39;DEC_CENT&#39;</span>]],) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="comment"># Set the type of event and psf_type</span></div>
<div class="line"><a name="l00157"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a6082a4cba3d179951abdb729ae60c196">  157</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a6082a4cba3d179951abdb729ae60c196">db_type</a> = (<span class="stringliteral">&#39;observation&#39;</span>,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00158"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a0116e190475703fb5b3d9b76304b203c">  158</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a0116e190475703fb5b3d9b76304b203c">psf_type</a> = (<span class="stringliteral">&#39;fisher&#39;</span>,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="comment"># Interpolate the pvalue from the SNR</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="comment">#FIXME Currently, if snr &lt; 2.6005, pvalue will be 0.  </span></div>
<div class="line"><a name="l00162"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#adcc3e0fbb64d16bea5cf6fadf3928309">  162</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#adcc3e0fbb64d16bea5cf6fadf3928309">pvalue</a> = tuple(float(<a class="code" href="../../d2/df9/namespaceswift__upload.html#a47786733b71afff4100ce30a5522235e">pvalue_interp_class</a>(snr)) <span class="keywordflow">for</span> snr <span class="keywordflow">in</span> self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#af99687a759f84b56ed61f2c1b3688dd8">snr</a>)</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                <span class="comment"># Set uncertainties</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                <span class="comment"># FIXME sigma_time commented out until an estimate of GRB</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                <span class="comment"># duration (sigma_t in the database) is found</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                <span class="comment">#self.sigma_time = (60,) * self.num_detection</span></div>
<div class="line"><a name="l00168"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a2a3ce10069190fb190c729936469661d">  168</a></span>&#160;                self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a2a3ce10069190fb190c729936469661d">sigma_r</a> = (0.05,) * self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                <span class="comment"># Set position flag to false.  If a problem arises in the</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                <span class="comment"># attitude files s.t. latitute, longitude, and elevation cannot</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                <span class="comment"># be accurately computed, this flag will be triggered</span></div>
<div class="line"><a name="l00173"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a30be5bbc348a999af0238626c752fece">  173</a></span>&#160;                self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a30be5bbc348a999af0238626c752fece">position_flag</a> = 0</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    </div>
<div class="line"><a name="l00175"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#abe0ec76289a38134e71c70edcd38fc29">  175</a></span>&#160;    <span class="keyword">def </span><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#abe0ec76289a38134e71c70edcd38fc29">set_pos_id</a>(self, id_interval_start, positions):</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="comment"># Sets position and event_id attributes This event_id is only</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="comment"># valid within the file that the events are coming from.  A</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="comment"># constant (possibly 0) will be added to all event_id&#39;s before</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="comment"># being uploaded to the database to maintain a consistent id</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="comment"># numbering</span></div>
<div class="line"><a name="l00181"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ae289f11447bfe0bd135c5a25678a7b02">  181</a></span>&#160;        self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ae289f11447bfe0bd135c5a25678a7b02">event_id</a> = tuple(id_interval_start + id_increment <span class="keywordflow">for</span> id_increment <span class="keywordflow">in</span> xrange(self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#ada5a57666f3fadbec980707149d07828">num_detection</a>))</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="comment">#Interpolate latitude, longitude, and elevation values</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="comment">#self.latitude, self.longitude, self.elevation = positions.interpolate_position(self.observation_time,self.num_detection,self.event_id[0])</span></div>
<div class="line"><a name="l00185"></a><span class="lineno"><a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4c3683d21e549cdc34edf5d3dc5dac03">  185</a></span>&#160;        self.latitude, self.longitude, self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a4c3683d21e549cdc34edf5d3dc5dac03">elevation</a> = positions.interpolate_position(self)</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keyword">def </span>set_position_flag(self):</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                self.<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html#a30be5bbc348a999af0238626c752fece">position_flag</a> = 1</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">##</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment"># </span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">#   Obtain the swift data as a list of class objects</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">#   </span></div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#a9d72a96223b34f720ff10ded383a85f4">  196</a></span>&#160;<span class="keyword">def </span><a class="code" href="../../d2/df9/namespaceswift__upload.html#a9d72a96223b34f720ff10ded383a85f4" title="Obtain the swift data as a list of class objects. ">get_swift_data</a>(fits_file_loc, pvalue_interp_class, positions):</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="comment"># Open the fits file, and then find the location of the relevant</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="comment"># columns</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;Opening monthly fits file %s&#39;</span> % fits_file_loc</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        fits_file = pyfits.open(fits_file_loc)[1]</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    data_list = [<span class="stringliteral">&#39;SNR&#39;</span>,<span class="stringliteral">&#39;TIME&#39;</span>,<span class="stringliteral">&#39;RA_OBJ&#39;</span>,<span class="stringliteral">&#39;DEC_OBJ&#39;</span>,<span class="stringliteral">&#39;RA_CENT&#39;</span>,<span class="stringliteral">&#39;DEC_CENT&#39;</span>]</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    data_list_arg = {prop: fits_file.columns.names.index(prop) <span class="keywordflow">for</span> prop <span class="keywordflow">in</span> data_list}</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment"># Create a list of class objects for all of the detections</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    all_events = [<a class="code" href="../../dd/d43/classswift__upload_1_1observation.html" title="Class to store all of the information needed by the MySQL database for a set of observations at a giv...">observation</a>(row, data_list_arg, pvalue_interp_class, positions) <span class="keywordflow">for</span> row <span class="keywordflow">in</span> fits_file.data]</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="comment"># Get rid of detections with no valid SNR values</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    snr_events = [event <span class="keywordflow">for</span> event <span class="keywordflow">in</span> all_events <span class="keywordflow">if</span> event.num_detection]</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment"># Set event id for databases.  Should be noted that these event ids</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment"># will only be relative to each other, and a constant will need to be</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="comment"># added before loading into the database</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    snr_events[0].set_pos_id(1, positions)</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">for</span> num, event <span class="keywordflow">in</span> enumerate(snr_events[1:]):</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        event.set_pos_id(snr_events[num].event_id[-1]+1, positions)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">return</span> snr_events</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">##</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment"># </span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">#   Open a file containing snr values and corresponding pvalues.  Use to created interpolate object</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">#   </span></div>
<div class="line"><a name="l00222"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#afd59363e3ba6ebbf496eba54eb48deab">  222</a></span>&#160;<span class="keyword">def </span><a class="code" href="../../d2/df9/namespaceswift__upload.html#afd59363e3ba6ebbf496eba54eb48deab" title="Open a file containing snr values and corresponding pvalues. ">interpolate_pvalue</a>(pvalue_file_loc): </div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    pvalue_file = open(pvalue_file_loc,<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="stringliteral">    snr_list = []</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="stringliteral">    pvalue_list = []</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="stringliteral">    i = 0</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="stringliteral">    </span><span class="keywordflow">for</span> line <span class="keywordflow">in</span> pvalue_file.readlines():</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        [snr, pvalue] = line.split(<span class="stringliteral">&#39; &#39;</span>)</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        snr_list.append(float(snr))</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        pvalue_list.append(float(pvalue))</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    pvalue_interp_class = interp1d(snr_list,pvalue_list,bounds_error=<span class="keyword">False</span>,fill_value=0.0)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span> pvalue_interp_class</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">##</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment"># </span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">#         Load the data into the MySQL database</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">#         </span></div>
<div class="line"><a name="l00238"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#ae4b72aa67bc1f3f066e245971cee64b1">  238</a></span>&#160;<span class="keyword">def </span><a class="code" href="../../d2/df9/namespaceswift__upload.html#ae4b72aa67bc1f3f066e245971cee64b1" title="Load the data into the MySQL database. ">db_load</a>(snr_events, pw, options):</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="comment"># Open the connection</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    con = mdb.connect(options.host,options.username,pw,options.database)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    with con:</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        cur = con.cursor() </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                <span class="comment"># Grab the highest id currently in the table event and set the</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                <span class="comment"># starting id to one higher.  id_start written as is to get an</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                <span class="comment"># int from a tuple</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                start_id = cur.execute(<span class="stringliteral">&quot;SELECT MAX(id) FROM event;&quot;</span>)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                id_start = [int(id) <span class="keywordflow">for</span> id <span class="keywordflow">in</span> cur.fetchone()][0]</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                <span class="comment"># Iterate through the events and load them into the database</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                <span class="comment"># Note that for SQL queries, need to use %s for placeholder</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                <span class="comment"># because MySQL will convert the value to a literal, not</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="comment"># python.</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(len(snr_events)):</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                        event_ids = tuple(event_id + id_start <span class="keywordflow">for</span> event_id <span class="keywordflow">in</span> snr_events[i].event_id)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            mysql_event_statement = <span class="stringliteral">&quot;INSERT INTO event(eventStreamConfig_stream, id, rev, time, time_msec, `Dec`, RA, sigmaR, pvalue, type, point_RA, `point_Dec`, \</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="stringliteral">                                        longitude, latitude, elevation, psf_type, eventStreamConfig_rev) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)&quot;</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            event_data = zip(snr_events[i].stream_config, event_ids, snr_events[i].rev, snr_events[i].time, snr_events[i].time_msec, \</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                        snr_events[i].dec_obj, snr_events[i].ra_obj, snr_events[i].sigma_r, snr_events[i].pvalue, snr_events[i].db_type, \</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                        snr_events[i].ra_cent, snr_events[i].dec_cent, snr_events[i].longitude, snr_events[i].latitude, snr_events[i].elevation, \</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                                        snr_events[i].psf_type, snr_events[i].stream_rev)</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                        mysql_parameter_statement = <span class="stringliteral">&quot;INSERT INTO parameter(name, value, units, event_eventStreamConfig_stream, event_id, event_rev) VALUES \</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="stringliteral">                                        (%s, %s, %s, %s, %s, %s)&quot;</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                        parameter_data = zip((<span class="stringliteral">&#39;position_accuracy_warning&#39;</span>,)*snr_events[i].num_detection, (snr_events[i].position_flag,)*snr_events[i].num_detection, \</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                                        (<span class="stringliteral">&#39;no units&#39;</span>,)*snr_events[i].num_detection, snr_events[i].stream_config, event_ids, snr_events[i].rev)</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            cur.executemany(mysql_event_statement,event_data)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            cur.executemany(mysql_parameter_statement,parameter_data)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">###########################################################################################################</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">###                                                 ###</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">###                     Main                            ###</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">###                                                 ###</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">###########################################################################################################</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment"># Parse the command line options</span></div>
<div class="line"><a name="l00277"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#a4d388713f6a0d16328488675c4d482a3">  277</a></span>&#160;options=<a class="code" href="../../d2/df9/namespaceswift__upload.html#afb3aeedcd6324609616af510e7d5ab77">parse_command_line</a>()</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment"># Get the MySQL database password</span></div>
<div class="line"><a name="l00280"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#ae6ff833c36ee2cf47e509afe217a0617">  280</a></span>&#160;pw = getpass.getpass(<span class="stringliteral">&#39;Database Password:&#39;</span>)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">#print sorted(glob.glob(options.attitude_files + &#39;/attitude_month*&#39;))</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment"># Get the files needed</span></div>
<div class="line"><a name="l00284"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#a377519eb5588b9332f113754e4baa783">  284</a></span>&#160;positions = <a class="code" href="../../d5/d94/classswift__upload_1_1attitude.html" title="Class to interpolate latitude, longitude, and elevation values from data taken from Swift attitude fi...">attitude</a>(sorted(glob.glob(options.attitude_files + <span class="stringliteral">&#39;/attitude_month*&#39;</span>)))</div>
<div class="line"><a name="l00285"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#abd11718745781fc3b22a4e8afb312c7b">  285</a></span>&#160;pvalue_file_loc = options.pvalue_file</div>
<div class="line"><a name="l00286"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#a3a9f04e4f02ad4c7b5626cee4d2888e8">  286</a></span>&#160;fits_file_locations = sorted(glob.glob(options.fits_files + <span class="stringliteral">&#39;/*&#39;</span>))</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment"># Create the interpolated pvalue class to convert from SNR to pvalue</span></div>
<div class="line"><a name="l00289"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#a47786733b71afff4100ce30a5522235e">  289</a></span>&#160;pvalue_interp_class = <a class="code" href="../../d2/df9/namespaceswift__upload.html#afd59363e3ba6ebbf496eba54eb48deab" title="Open a file containing snr values and corresponding pvalues. ">interpolate_pvalue</a>(pvalue_file_loc)</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment"># Get the events from the fits files</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordflow">for</span> fits_file <span class="keywordflow">in</span> fits_file_locations:</div>
<div class="line"><a name="l00293"></a><span class="lineno"><a class="code" href="../../d2/df9/namespaceswift__upload.html#aa7b8b09b55bc451f3bf4383f952dbe80">  293</a></span>&#160;        snr_events = <a class="code" href="../../d2/df9/namespaceswift__upload.html#a9d72a96223b34f720ff10ded383a85f4" title="Obtain the swift data as a list of class objects. ">get_swift_data</a>(fits_file, pvalue_interp_class, positions)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <a class="code" href="../../d2/df9/namespaceswift__upload.html#ae4b72aa67bc1f3f066e245971cee64b1" title="Load the data into the MySQL database. ">db_load</a>(snr_events, pw, options)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 25 2014 22:22:31 for AmonPy by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.4
</small></address>
</body>
</html>
